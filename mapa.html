
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mapa Interativo Refatorado</title>
  <link rel="icon" href="../icon.png">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/mapa.css">
  <script defer src="js/ui.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
  <script type="module">
    import { MapaTerritorios } from './MapaTerritorios.js';

    document.addEventListener('DOMContentLoaded', async () => {
      const mapa = document.getElementById('mapa-svg');
      const filtroSelect = document.getElementById('filtroSaida');
      const buscaInput = document.getElementById('buscaTerritorio');
      const legenda = document.getElementById('legenda-grupos');
      const painel = document.getElementById('painel-info');

      if (!window.api?.territorios || !window.api?.designacoes) {
        alert("API não disponível.");
        return;
      }

      const territorios = await window.api.territorios.listar();
      const designacoes = await window.api.designacoes.listar();

      mapa.addEventListener('load', () => {
        const svgDoc = mapa.contentDocument;
        const svgElement = svgDoc.documentElement;

        const panZoom = svgPanZoom(svgElement, {
          zoomEnabled: true,
          controlIconsEnabled: true,
          fit: true,
          center: true,
          minZoom: 0.5,
          maxZoom: 10
        });

        const app = new MapaTerritorios(svgDoc, territorios, designacoes, legenda, painel);
        app.init();

        filtroSelect.addEventListener('change', () => {
          app.renderizarMapa(filtroSelect.value, buscaInput.value);
        });

        buscaInput.addEventListener('input', () => {
          app.renderizarMapa(filtroSelect.value, buscaInput.value);
        });

        document.getElementById('zoomIn').onclick = () => panZoom.zoomIn();
        document.getElementById('zoomOut').onclick = () => panZoom.zoomOut();
        document.getElementById('resetZoom').onclick = () => panZoom.resetZoom();
      });
    });
  </script>
</head>
<body>
<header>
  <button class="menu-toggle" onclick="toggleMenu()"><span class="material-icons">menu</span></button>
  <div class="top-actions">
    <button title="Alterar tema" onclick="toggleTema()"><span class="material-icons">brightness_6</span></button>
    <button title="Fechar aplicativo" onclick="fecharApp()"><span class="material-icons">close</span></button>
  </div>
</header>

<nav>
  <h2><span class="material-icons">map</span> Mapa</h2>
  <ul>
        <li><a href="index.html" title="Início"><span class="material-icons">home</span> Início</a></li>
        <li><a href="territorios.html" title="Territórios"><span class="material-icons">description</span> Territórios</a></li>
        <li><a href="mapa.html" title="Mapa"><span class="material-icons">map</span> Mapa</a></li>
        <li><a href="saidas.html" title="Saídas"><span class="material-icons">directions_walk</span> Saídas</a></li>
        <li><a href="designacoes.html" title="Designações"><span class="material-icons">push_pin</span> Designações</a></li>
        <li><a href="calendario.html" title="Calendário"><span class="material-icons">event</span> Calendário</a></li>
        <li><a href="sugestoes.html" title="Sugestões"><span class="material-icons">lightbulb</span> Sugestões</a></li>
        <li><a href="relatorios.html" title="Relatórios"><span class="material-icons">bar_chart</span> Relatórios</a></li>
        <li><a href="dashboard.html" title="Dashboard"><span class="material-icons">show_chart</span> Dashboard</a></li>
        <li><a href="coleta.html" title="Coleta"><span class="material-icons">cloud_download</span> Coleta</a></li>
        <li><a href="logs.html"><span class="material-icons">bug_report</span> Logs</a></li>
        <li><a href="configuracoes.html" title="Configurações"><span class="material-icons">settings</span> Configurações</a></li>
        <li><a href="ajuda.html" title="Ajuda"><span class="material-icons">help</span> Ajuda</a></li>
        <li><a href="sobre.html" title="Sobre"><span class="material-icons">info</span> Sobre</a></li>
  </ul>
</nav>

<main>
  <h1><span class="material-icons">map</span> Mapa Interativo Refatorado</h1>

  <div class="filtro-container">
    <label for="filtroSaida"><strong>🔎 Filtrar por grupo de saída:</strong></label>
    <select id="filtroSaida"><option value="todos">Todos</option></select>
    <input type="text" id="buscaTerritorio" placeholder="🔍 Buscar território..." style="margin: 10px 0; width: 100%; max-width: 300px; padding: 6px;">
  </div>

  <div id="mapa-container">
    <object id="mapa-svg" type="image/svg+xml" data="assets/mapa.svg" aria-label="Mapa Interativo" style="width: 100%; height: 100%;"></object>
  </div>

  <div style="margin: 10px 0; text-align: center;">
    <button id="zoomIn">➕ Zoom In</button>
    <button id="zoomOut">➖ Zoom Out</button>
    <button id="resetZoom">🔄 Reset</button>
  </div>

  <div id="legenda-grupos" style="display: flex; flex-wrap: wrap; gap: 10px; margin: 10px 0;"></div>

  <section id="painel-info">
    <button id="fechar-info" class="modal-close" aria-label="Fechar">×</button>
  </section>

  <button id="voltarTopo" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
    <span class="material-icons">arrow_upward</span>
  </button>
</main>

<footer id="barra-status">
    <span id="status-usuario">👤 Usuário: ...</span>
    <span id="status-nivel">🔐 Nível: ...</span>
    <span id="status-acao">📌 Aguardando ações...</span>
    <span id="status-conexao">🟢 Conectado</span>
</footer>
</body>
</html>
